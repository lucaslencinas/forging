# Cloud Run service configuration for the backend
# Deploy with: gcloud run services replace backend-cloudrun.yaml --region=us-central1
#
# Note: This file is for reference/manual deploys. GitHub Actions uses gcloud run deploy directly.
# Replace PROJECT_ID with your actual GCP project ID before using.

apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: forging-backend
  labels:
    cloud.googleapis.com/location: us-central1
spec:
  template:
    metadata:
      annotations:
        # Allow up to 10 concurrent requests per instance
        autoscaling.knative.dev/maxScale: "10"
        autoscaling.knative.dev/minScale: "0"
        # Increase timeout for AI processing (10 minutes)
        run.googleapis.com/timeout: "600s"
    spec:
      containerConcurrency: 10
      timeoutSeconds: 600
      containers:
        # Updated to use Artifact Registry (gcr.io is deprecated)
        - image: us-central1-docker.pkg.dev/PROJECT_ID/forging/forging-backend:latest
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: "2"
              memory: "4Gi"
          env:
            - name: GOOGLE_CLOUD_PROJECT
              value: "PROJECT_ID"
            - name: GCS_BUCKET_NAME
              value: "forging-uploads"
            - name: ALLOWED_ORIGINS
              value: "https://forging-frontend-HASH.run.app,http://localhost:3000"
            # Add other environment variables as needed
