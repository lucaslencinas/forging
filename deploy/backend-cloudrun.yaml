# Cloud Run service configuration for the backend
# Deploy with: gcloud run services replace backend-cloudrun.yaml

apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: forging-backend
  labels:
    cloud.googleapis.com/location: us-central1
spec:
  template:
    metadata:
      annotations:
        # Allow up to 10 concurrent requests per instance
        autoscaling.knative.dev/maxScale: "10"
        autoscaling.knative.dev/minScale: "0"
        # Increase timeout for AI processing (5 minutes)
        run.googleapis.com/timeout: "300s"
    spec:
      containerConcurrency: 10
      timeoutSeconds: 300
      containers:
        - image: gcr.io/PROJECT_ID/forging-backend:latest
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: "2"
              memory: "2Gi"
          env:
            - name: GOOGLE_CLOUD_PROJECT
              value: "PROJECT_ID"
            - name: GCS_BUCKET_NAME
              value: "forging-uploads"
            - name: ALLOWED_ORIGINS
              value: "https://forging-frontend-HASH.run.app,http://localhost:3000"
            # GEMINI_API_KEY should be set via Secret Manager
